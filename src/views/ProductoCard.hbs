<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Fuente moderna desde Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link rel="stylesheet" href="../css/ProductoCard.css">
 <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

</head>

<body>
    {{#each card}}
    <article class="card" id="product-card">
        <input id="cod_{{id_producto}}" value="{{id_producto}}" hidden> </input>
        <input id="desc_{{id_producto}}" value="{{titulo}}" hidden> </input>
        <input style="width: 80px;" type="number" class="quantity.input"  value="1" id="cantidad" hidden>  </input>
        <input id="precio_{{id_producto}}" value={{precio1}} readonly hidden></input>
        <input id="foto_{{id_producto}}" value="{{foto2}}" hidden></input>
        <input id="items" hidden></input>

        <div>
            <h3 class="!w-full text-2xl !font-bold !text-blue-600 uppercase tracking-wider mb-1 !text-center">
                {{titulo}}</h3>

        </div>
        <!-- Botón Cerrar -->
        <button class="close-btn" onclick="closeCard()" aria-label="Cerrar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Imagen -->
        <div class="image-container">
            <img src="{{foto2}}" alt="Headphones">
        </div>

        <!-- Contenido -->
        <div class="content">
            <h2 class="!w-full text-2xl !font-bold !text-blue-600 uppercase tracking-wider mb-1 !text-center">
                {{des}}</h2>
            <p></p>

            <p class="price-tag">$ {{precio1f}}</p>

            <!-- Controles de Cantidad -->
            <div class="quantity-wrapper">
                <button class="btn-qty" onclick="updateQty(-1)">−</button>
                <span id="qty-value">1</span>
                <button class="btn-qty" onclick="updateQty(1)">+</button>
            </div>

            <!-- Botón de Acción -->
            <button class="btn-add sumacanasto" value="{{id_producto}}">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                Añadir al carrito
            </button>
            <p>{{nota}}</p>
        </div>
        {{/each}}
    </article>
     <script src="https://code.jquery.com"></script>
    <script type="text/javascript">
        // Lógica de Cantidad
        let quantity = 1;
        const qtyDisplay = document.getElementById('qty-value');
        /*const cantidad = document.getElementById('cantidad');
        console.log("cantidad", cantidad);*/

        function updateQty(value) {
            quantity += value;
            if (quantity < 1) quantity = 1;
            qtyDisplay.innerText = quantity;
            document.getElementById('cantidad').value = quantity; 
        }

        // Lógica para cerrar la tarjeta con animación
        function closeCard() {
            console.log("funcion closeCard");
            window.history.back();
        }


        $('.sumacanasto').on('click', function (e) {

            console.log('agregar carrito');
            console.log(e.target);
            const cant = parseFloat(document.getElementById('cantidad').value)
            var id = (e.target.value)
            //console.log("codigo", id)
            //console.log("cantidad", cant);
            const ttl = parseFloat($("#precio_" + id).val()) * cant;
            //console.log("total", ttl);
            // var stotal =  parseFloat($("#total_" + id).val());

            const infoProducto = {
                id: id,
                desc: $("#desc_" + id).val(),
                img: $("#foto_" + id).val(),
                cant: cant,
                precio: parseFloat($("#precio_" + id).val()),
                tipo:"" ,
                stotal: ttl
            };
            console.log("infoproducto", infoProducto);

            if (cant == 0) {


                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'El producto debe ser mayor a 0',
                    showConfirmButton: false,
                    timer: 2000
                })
            }
            else {
                let productosLS;
                items = 0;
                productosLS = obtenerProductosLocalStorage();
                productosLS.forEach(function (productoLS) {

                    items++;
                    if (productoLS.id === infoProducto.id) {
                        productosLS = productoLS.id;
                    }
                });



                if (productosLS === infoProducto.id) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'El producto ya está en el carrito',
                        showConfirmButton: false,
                        timer: 2000
                    })
                }
                else {

                    let productos = [];
                    productos = obtenerProductosLocalStorage();
                    productos.push(infoProducto);
                    localStorage.setItem('productos', JSON.stringify(productos));
                    document.getElementById('items').value = productos.length;
                    Swal.fire({
                        icon: 'success',
                        title: 'Producto agregado al carrito',
                        showConfirmButton: false,
                        timer: 1500
                    })
                    closeCard()
                }


            }
        });

        function obtenerProductosLocalStorage() {
            let productoLS;
            //Comprobar si hay algo en LS
            if (localStorage.getItem('productos') === null) {
                console.log('no esta este producto');
                productoLS = [];
            }
            else {
                console.log('tiene');
                console.dir(localStorage.getItem('productos'));
                productoLS = JSON.parse(localStorage.getItem('productos'));

            }
            return productoLS;
        }

    </script>

</body>

</html>